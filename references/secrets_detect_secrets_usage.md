## detect-secrets (シークレット検知) 利用ガイド

detect-secrets は、ソースコードや設定ファイルにハードコードされた可能性のあるシークレット (APIキー、パスワードなど) を検出するツールです。

### 1. インストール
```bash
pip install detect-secrets
```

### 2. 基本的な使い方

- **スキャンの実行:**
  プロジェクトのルートディレクトリで以下を実行します。
  ```bash
  detect-secrets scan
  ```
  これにより、`.secrets.baseline` ファイルが生成または更新され、検出されたシークレットが記録されます。

- **ベースラインファイルとは:**
  `.secrets.baseline` は、プロジェクトで意図的に許可したシークレット (誤検知やテスト用のダミーシークレットなど) を記録しておくためのファイルです。
  初回スキャン後、このファイルを確認し、本当に問題のあるシークレットのみを修正対象とします。

- **ベースラインファイルの確認と更新:**
  ```bash
  detect-secrets audit .secrets.baseline
  ```
  このコマンドで対話的にベースラインファイル内の各シークレットを確認し、許可するかどうかを決定できます。

- **CI/CDでの利用 (ベースラインとの比較):**
  CI/CDパイプラインでは、新たにコミットされたコードにベースラインに記録されていないシークレットが含まれていないかをチェックします。
  ```bash
  detect-secrets scan --baseline .secrets.baseline
  ```
  もし新しいシークレットが見つかると、非ゼロの終了コードで失敗します。

### 3. AIエージェントの役割 (mode_secret_detection.mdc から呼び出される場合)
1. **実行**: PMからの指示、CI/CDパイプライン、またはコミット時に自律的に `detect-secrets scan` を実行する。
   - `--baseline .secrets.baseline` オプションを付けて、既存のベースラインとの差分をチェックすることが推奨される。
2. **結果の解釈と報告**:
   - スキャン結果 (特にベースラインとの差分がある場合) を確認する。
   - 新たに検出されたシークレット (ベースラインにないもの) について、以下をPMに報告する:
     - `filename`: シークレットが検出されたファイル名
     - `line_number`: 行番号
     - `type`: 検出されたシークレットのタイプ (例: `Base64HighEntropyString`, `HexHighEntropyString`, `PrivateKey`など)
     - `secret_hashed`: ハッシュ化されたシークレット (実際の値は表示されない)
   - これが本当に機密情報であるか、それとも誤検知や意図的なもの (テストデータなど) であるかを確認するようPMに促す。
3. **修正提案**: 検出されたシークレットが実際に機密情報である場合、以下の対応を提案する:
   - 環境変数からの読み込みに変更する。
   - 専用のシークレット管理サービス (HashiCorp Vault, AWS Secrets Managerなど) を利用する。
   - 設定ファイル (`.env` など) から読み込み、その設定ファイルをGit管理外とする。
   - コード例も提示できるとより良い。
4. **ベースライン更新の提案**: もし検出されたシークレットが安全であるとPMが判断した場合 (例: テスト用のダミーキー)、`detect-secrets audit .secrets.baseline` を実行してベースラインを更新するようPMに提案する。
5. **安全なコーディング支援**: コード生成時に、シークレットを直接埋め込むのではなく、環境変数や設定ファイルから読み込むパターンを自律的に適用する。

### 4. プラグイン
detect-secrets はプラグインアーキテクチャを採用しており、特定のサービス (AWS, Azure, GCPなど) のキーパターンを検出するプラグインなどが存在します。

### 5. 注意点
- detect-secrets はあくまで「可能性のある」シークレットを検出するツールであり、最終的な判断は人間が行う必要があります。
- ベースラインファイル (`.secrets.baseline`) の適切な管理が重要です。

### 6. 参考
- [detect-secrets GitHub](https://github.com/Yelp/detect-secrets) 